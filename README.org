#+TITLE: Claude Code Metrics Lab
#+DESCRIPTION: OpenTelemetry-based metrics tracking and analysis for Claude Code usage

* Overview
This lab provides tools and dashboards for tracking Claude Code usage across projects.

* Features
- Real-time metrics collection via OTEL
- Custom Grafana dashboards
- Cost analysis and projections
- Usage pattern analysis
- Per-project tracking
- Model comparison metrics

* Quick Start
1. Ensure OTEL infrastructure is running (see pi-setup)
2. Import dashboards from =dashboards/=
3. Run analysis scripts from =src/=

* Dashboard Preview

#+begin_src mermaid :file docs/dashboard.png :tangle docs/dashboard.mmd
graph TB
    subgraph "Claude Code Metrics Enhanced Dashboard"
        subgraph "Row 1 - Key Metrics (4 units high)"
            S1[Total Sessions<br/>Counter: session_count_total]
            S2[Total Tokens Used<br/>Counter: token_usage_tokens_total]
            S3[Total Cost USD<br/>Counter: cost_usage_USD_total]
            S4[Total Commits<br/>Counter: commit_count_total]
        end
        
        subgraph "Row 2 - Usage Trends (8 units high)"
            TS1[Token Usage Rate by Type<br/>Time Series<br/>Grouped by: type]
            TS2[Cost Rate by Model<br/>Time Series<br/>Grouped by: model]
        end
        
        subgraph "Row 3 - Model Breakdown (8 units high)"
            T1[Usage by Model<br/>Table View<br/>Shows: Tokens & Cost per model]
        end
        
        subgraph "Row 4 - Activity Analysis (8 units high)"
            TS3[Hourly Token Usage<br/>Stacked Bar Chart<br/>Grouped by: model]
            TS4[Activity Rate<br/>Time Series<br/>Sessions/sec & Commits/sec]
        end
    end
    
    style S1 fill:#2d4a2b,stroke:#73bf69,color:#fff
    style S2 fill:#4a4a2b,stroke:#f2cc0c,color:#fff
    style S3 fill:#4a4a2b,stroke:#f2cc0c,color:#fff
    style S4 fill:#2d4a2b,stroke:#73bf69,color:#fff

#+end_src

#+RESULTS:
[[file:docs/dashboard.png]]


#+begin_example
â”Œâ”€ Claude Code Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                   â”‚
â”‚ ğŸ“Š Token Usage (24h)        ğŸ’° Cost Tracking        ğŸ• Sessions  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Input:   45.2K  â”‚         â”‚ Today:   $2.34  â”‚     â”‚ Active: â”‚  â”‚
â”‚ â”‚ Output:  23.1K  â”‚         â”‚ Week:   $14.67  â”‚     â”‚   ğŸŸ¢ 3  â”‚  â”‚
â”‚ â”‚ Cache:    8.9K  â”‚         â”‚ Month:  $51.23  â”‚     â”‚ Total:  â”‚  â”‚
â”‚ â”‚ Ratio:    0.51  â”‚         â”‚ Trend:     â†—    â”‚     â”‚   ğŸ“ˆ 87 â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚ ğŸ¯ Top Projects              ğŸ“ˆ Usage Patterns      ğŸ¤– Models    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ claude-metrics  â”‚         â”‚     Hour Usage  â”‚     â”‚ Haiku   â”‚  â”‚
â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 34.2%  â”‚         â”‚ 09: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â”‚     â”‚ â–ˆâ–ˆ 45%  â”‚  â”‚
â”‚ â”‚ web-scraper     â”‚         â”‚ 14: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ       â”‚     â”‚ Sonnet  â”‚  â”‚
â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    21.1%  â”‚         â”‚ 16: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚     â”‚ â–ˆâ–ˆâ–ˆ 55% â”‚  â”‚
â”‚ â”‚ data-analysis   â”‚         â”‚ 20: â–ˆâ–ˆâ–ˆâ–ˆ        â”‚     â”‚ Opus    â”‚  â”‚
â”‚ â”‚ â–ˆâ–ˆâ–ˆ      18.3%  â”‚         â”‚ Peak: 4-6 PM    â”‚     â”‚ â–Œ 2%    â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚ ğŸ” Efficiency Score: 87/100  âš¡ Avg Response: 1.2s  ğŸ“Š Since: 30dâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#+end_example

* Usage

** Running Analysis
#+begin_src bash
# Project metrics
python3 src/project_metrics.py

# Cost analysis  
python3 src/cost_analyzer.py

# Session patterns
python3 src/session_analyzer.py
#+end_src

** Tangle Configuration
#+begin_src bash
# Extract all source files from SETUP.org
make tangle
#+end_src

** Dashboard Generation
#+begin_src bash
# Generate Grafana dashboards from templates
make dashboards

# Generate for specific environments
make dashboards-dev    # Development settings
make dashboards-prod   # Production settings

# Manual generation with options
uv run python scripts/generate_dashboards.py --environment staging
#+end_src

* Requirements
- Python 3.8+
- OpenTelemetry infrastructure
- Prometheus and Grafana
- Claude Code with telemetry enabled

See =docs/setup.org= for detailed setup instructions.
